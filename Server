import java.io.*;
import java.net.*;
import java.util.concurrent.TimeUnit;
import java.awt.*;
import java.awt.event.*;
import javax.swing.*;

public class Server extends JFrame {
	
	public static Register register = new Register();

	
	private JFrame frame;
	
	private JTextField userText; //javax.swing
	private JTextArea chatWindow; //javax.swing
	private ObjectOutputStream output; //java.io
	private ObjectInputStream input; //java.io
	private ServerSocket server; //java.net
	private Socket connection; //java.net
		
	
		//constructor
	  public Server() 
	  {
		  frame = new JFrame("Server");
		  
		  frame.setBounds(10,10,300,150);
		  frame.setResizable(true);
		  

			
		  userText = new JTextField();
		  userText.setEditable(false);
		  
		  
		  frame.add(userText,BorderLayout.NORTH);
		  chatWindow = new JTextArea();
		  frame.add(new JScrollPane(chatWindow));
		  
		  frame.setVisible(true);
	
		  userText.addActionListener(
				  new ActionListener(){
			  public void actionPerformed(ActionEvent event) {
				  sendMessage(event.getActionCommand());
				  userText.setText("");
			  }
		  }
				  
	);
		  
		  
		  
	  }
	  
	  public void runApplication()
	  {
		  try {

			  server = new ServerSocket(6789, 100);
			  while (true)
			  {
				  try {

					  waitForConnection();
					  setupStreams();
					  whileChatting();
					  
				  }
				  catch(EOFException eofException)
				  {
					  
					  displayMessage("\n Server ended the connection!");
				  }finally {
					  closeAll();
				  }
				  
			  }
		  }
		  
		  catch(IOException ioException)
		  {
			  ioException.printStackTrace();
		  }
		  
	  }
	  
	  //wait for connection, then display connection infornation
	  private void waitForConnection() throws IOException
	  {
		  
		  displayMessage (" \nWaiting for someone to connect...\n");
		  connection = server.accept();
		  displayMessage (" Now connected to "+connection.getInetAddress().getHostName());
		  
	  }
	  //get stream to send and receive data
	  private void setupStreams() throws IOException
	  {
		  output = new ObjectOutputStream(connection.getOutputStream());
		  output.flush();
		  
		  input = new ObjectInputStream(connection.getInputStream());
		  
		  displayMessage("\n Streams are now setup!");
	  }
	  //during the chat conversation
	  private void whileChatting () throws IOException
	  {
		  String message = "You are now connected! ";
		  sendMessage(message);
		  ableToType(true);
		  
		  //have a convo
		  do
		  {
			  try {
				  message = (String) input.readObject();
				  displayMessage("\n"+message);
			  }
			  catch(ClassNotFoundException classNotFoundException) {
				  displayMessage("\nERROR: Connector sent incorrect Input");
			  }
		  }
		  //end conversation
		  while(!message.equals("CLIENT - END"));
	  }
	  
	  //close streams and sockets
	  private void closeAll()
	  {
		  displayMessage("\n Closing connections...");
		  ableToType(false);
		  try {
			  output.close();
			  input.close();
			  connection.close();
			  
		  }
		  catch(IOException ioException)
		  {
			 ioException.printStackTrace(); 
		  }
	  }
	  
	  //send a message to client
	  private void sendMessage(String message)
	  {
		  try
		  {
			  output.writeObject(register.user+ " - "+message);
			  output.flush();
			  displayMessage("\n"+ register.user+" - "+message);
		  }
		  catch(IOException ioException){
			  chatWindow.append("\nERROR: Unable to send message!");
		  }
	  }
	  
	  //updates chatWindow
	  private void displayMessage(final String text)
	  {

		  SwingUtilities.invokeLater(
				  new Runnable() {
					  public void run()
					  {
						  chatWindow.append(text);
					  }
				  }
				  
				);
	  }
	  
	  private void ableToType(final boolean editable)
	  {
		  SwingUtilities.invokeLater(
				  new Runnable() {
					  public void run()
					  {
						  userText.setEditable(editable);
					  }
				  }
				  
				);
	  }
	  
	  public static void main(String[] args) throws InterruptedException {
			
			
					while(true)
					{
						//System.out.println(register.getLoggedIn()+"");

						if (register.getLoggedIn()==1)
						{
							Server server = new Server();
							server.runApplication();
							break;
						}
						
						else
						{
							TimeUnit.SECONDS.sleep(1);
						}
						
					}
					
				
		}
	  
	 
	

}
